name: Update Profile README with Blog Posts

on:
  schedule: # 定时触发（每天运行一次）
    - cron: "0 0 * * *"
  workflow_dispatch: # 手动触发

jobs:
  update-readme:
    runs-on: ubuntu-latest

    steps:
      # 1. 从博客页面抓取最新文章
      - name: Fetch latest blog posts
        run: |
          echo "Fetching blog posts from https://mikalasa.github.io/my-blog/"
          curl -s https://mikalasa.github.io/my-blog/ > blog_home.html

          echo "## 📚 最新博客文章" > articles_list.md
          # 提取文章链接和标题（调整正则表达式适应你的页面结构）
          grep -oP '<a href="[^"]*" class="post-link">[^<]*</a>' blog_home.html | head -n 5 | while read -r line; do
            link=$(echo "$line" | grep -oP '(?<=<a href=")[^"]*') # 提取链接
            title=$(echo "$line" | grep -oP '(?<=class="post-link">)[^<]*') # 提取标题
            full_link="https://mikalasa.github.io/my-blog$link"
            echo "- [$title]($full_link)" >> articles_list.md
          done

      # 2. Checkout Profile 仓库
      - name: Checkout profile repository
        uses: actions/checkout@v3
        with:
          repository: Mikalasa/Mikalasa
          token: ${{ secrets.GITHUB_TOKEN }}
          path: profile_repo

      # 3. 更新 README 文件
      - name: Update README
        run: |
          cd profile_repo
          # 替换 <!-- BLOG-POST-LIST:START --> 和 <!-- BLOG-POST-LIST:END --> 之间的内容
          sed -i '/<!-- BLOG-POST-LIST:START -->/,/<!-- BLOG-POST-LIST:END -->/c\<!-- BLOG-POST-LIST:START -->\n'"$(cat ../articles_list.md)"'\n<!-- BLOG-POST-LIST:END -->' README.md

      # 4. 提交更改
      - name: Commit and push changes
        run: |
          cd profile_repo
          git config --local user.name "GitHub Actions"
          git config --local user.email "actions@github.com"
          git add README.md
          git commit -m "Update articles list in README"
          git push origin main

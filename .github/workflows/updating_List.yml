name: Update Profile README with Blog Posts

on:
  schedule:
    - cron: "0 0 * * *" # æ¯å¤©å®šæ—¶è§¦å‘
  workflow_dispatch: # æ‰‹åŠ¨è§¦å‘

jobs:
  update-readme:
    runs-on: ubuntu-latest

    steps:
      # 1. å®‰è£… XML å·¥å…·å¹¶è§£æ RSS
      - name: Install XML utilities
        run: |
          sudo apt-get update
          sudo apt-get install -y libxml2-utils

      # 2. è·å–å¹¶è§£æ RSS
      - name: Fetch and parse RSS feed
        run: |
          echo "Fetching RSS feed from https://mikalasa.github.io/my-blog/rss.xml"
          curl -s https://mikalasa.github.io/my-blog/rss.xml > rss.xml

          echo "## ğŸ“š Latest Blog Posts" > articles_list.md
          xmllint --xpath "//item[position() <= 5]" rss.xml | \
          xmllint --format - | \
          while IFS= read -r line; do
            if [[ $line =~ \<title\>(.*)\<\/title\> ]]; then
              title=${BASH_REMATCH[1]}
            fi
            if [[ $line =~ \<link\>(.*)\<\/link\> ]]; then
              link=${BASH_REMATCH[1]}
              # ä¿®æ­£é“¾æ¥ï¼Œå¢åŠ  /my-blog/ å‰ç¼€
              full_link=$(echo "$link" | sed 's|https://mikalasa.github.io/posts/|https://mikalasa.github.io/my-blog/posts/|')
            fi
            if [[ $line =~ \<pubDate\>(.*)\<\/pubDate\> ]]; then
              pub_date=${BASH_REMATCH[1]}
              # æ ¼å¼åŒ–æ—¥æœŸï¼Œåªä¿ç•™ å¹´-æœˆ-æ—¥
              formatted_date=$(date -d "$pub_date" +"%Y-%m-%d")
              echo "- [$title]($full_link) - $formatted_date" >> articles_list.md
            fi
          done

          echo "Generated articles_list.md:"
          cat articles_list.md



      # 3. æ£€å‡º Profile ä»“åº“
      - name: Checkout profile repository
        uses: actions/checkout@v3
        with:
          repository: Mikalasa/Mikalasa
          token: ${{ secrets.GITHUB_TOKEN }}
          path: profile_repo

      # 4. ä½¿ç”¨ awk æ›¿æ¢ README æ–‡ä»¶ä¸­çš„å†…å®¹
      - name: Update README
        run: |
          cd profile_repo
          awk '
            BEGIN { inside=0 }
            /<!-- BLOG-POST-LIST:START -->/ { print; inside=1; system("cat ../articles_list.md"); next }
            /<!-- BLOG-POST-LIST:END -->/ { inside=0 }
            !inside { print }
          ' README.md > README.tmp && mv README.tmp README.md
          echo "Updated README.md content:"
          cat README.md


      # 5. æäº¤æ›´æ”¹
      - name: Commit and push changes
        run: |
          cd profile_repo
          git config --local user.name "GitHub Actions"
          git config --local user.email "actions@github.com"
          git add README.md
          git commit -m "Update articles list in README" || echo "No changes to commit"
          git push origin main || echo "No changes to push"

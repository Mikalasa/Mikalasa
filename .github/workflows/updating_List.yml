name: Update Profile README with Blog Posts

on:
  schedule: # å®šæ—¶è§¦å‘ï¼ˆæ¯å¤©è¿è¡Œä¸€æ¬¡ï¼‰
    - cron: "0 0 * * *"
  workflow_dispatch: # æ‰‹åŠ¨è§¦å‘

jobs:
  update-readme:
    runs-on: ubuntu-latest

    steps:
      # 1. ä»åšå®¢é¡µé¢æŠ“å–æœ€æ–°æ–‡ç« 
      - name: Fetch latest blog posts
        run: |
          echo "## ğŸ“š æœ€æ–°åšå®¢æ–‡ç« " > articles_list.md
          # ä½¿ç”¨ curl è·å–åšå®¢é¡µé¢ HTML
          curl -s https://mikalasa.github.io/my-blog/ > blog_home.html

          # æå–æ–‡ç« å¡ç‰‡çš„é“¾æ¥ã€æ ‡é¢˜å’Œæ—¥æœŸ
          grep -oP '<a href="[^"]*" class="post-link">[^<]*</a>' blog_home.html | head -n 5 | while read -r line; do
            # æå–æ–‡ç« é“¾æ¥
            link=$(echo "$line" | grep -oP '(?<=<a href=")[^"]*')
            # æå–æ–‡ç« æ ‡é¢˜
            title=$(echo "$line" | grep -oP '(?<=class="post-link">)[^<]*')
            # æå–æ–‡ç« æ—¥æœŸï¼ˆå‡è®¾æ—¥æœŸæ˜¯ <time> æ ‡ç­¾ï¼‰
            date=$(grep -A 5 "$line" blog_home.html | grep -oP '(?<=<time>)[^<]*')
            full_link="https://mikalasa.github.io/my-blog$link"
            echo "- [$title]($full_link) - $date" >> articles_list.md
          done

      # 2. Checkout Profile ä»“åº“
      - name: Checkout profile repository
        uses: actions/checkout@v3
        with:
          repository: Mikalasa/Mikalasa
          token: ${{ secrets.GITHUB_TOKEN }}
          path: profile_repo

      # 3. æ›´æ–° README æ–‡ä»¶
      - name: Update README
        run: |
          cd profile_repo
          sed -i '/## ğŸ“š æœ€æ–°åšå®¢æ–‡ç« /,$d' README.md # åˆ é™¤æ—§çš„æ–‡ç« åˆ—è¡¨
          cat ../articles_list.md >> README.md # æ’å…¥æ–°çš„æ–‡ç« åˆ—è¡¨

      # 4. æäº¤æ›´æ”¹
      - name: Commit and push changes
        run: |
          cd profile_repo
          git config --local user.name "GitHub Actions"
          git config --local user.email "actions@github.com"
          git add README.md
          git commit -m "Update articles list in README"
          git push origin main

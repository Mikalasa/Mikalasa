name: Update Profile README with Blog Posts

on:
  schedule:
    - cron: "0 0 * * *"
  workflow_dispatch:

jobs:
  update-readme:
    runs-on: ubuntu-latest

    steps:
      # 1. ‰ªéÂçöÂÆ¢È°µÈù¢ÊäìÂèñÊúÄÊñ∞ÊñáÁ´†
      - name: Fetch latest blog posts
        run: |
          echo "Fetching blog posts from https://mikalasa.github.io/my-blog/"
          curl -s https://mikalasa.github.io/my-blog/ > blog_home.html

          echo "## üìö ÊúÄÊñ∞ÂçöÂÆ¢ÊñáÁ´†" > articles_list.md
          grep -oP '<a href="[^"]*" class="transition font-bold active:text-[^>]+>.*?</a>' blog_home.html | head -n 5 | while read -r link_line; do
            link=$(echo "$link_line" | grep -oP '(?<=<a href=")[^"]*')
            title=$(echo "$link_line" | grep -oP '(?<=class="transition font-bold active:text-[^>]+>).*(?=</a>)')
            description=$(grep -A 5 "$link_line" blog_home.html | grep -oP '(?<=<div class="transition line-clamp-2 .*?>).*?(?=</div>)' | head -n 1)
            date=$(grep -A 10 "$link_line" blog_home.html | grep -oP '\d{4}-\d{2}-\d{2}' | head -n 1)
            full_link="https://mikalasa.github.io/my-blog$link"
            echo "- [$title]($full_link) - $date" >> articles_list.md
            echo "  - $description" >> articles_list.md
          done

          echo "Generated articles_list.md:"
          cat articles_list.md

      # 2. Checkout Profile ‰ªìÂ∫ì
      - name: Checkout profile repository
        uses: actions/checkout@v3
        with:
          repository: Mikalasa/Mikalasa
          token: ${{ secrets.GITHUB_TOKEN }}
          path: profile_repo

      # 3. Êõ¥Êñ∞ README Êñá‰ª∂
      - name: Update README
        run: |
          cd profile_repo
          python3 -c "
import re
with open('README.md', 'r') as file:
    content = file.read()
new_content = re.sub(
    r'<!-- BLOG-POST-LIST:START -->.*?<!-- BLOG-POST-LIST:END -->',
    '<!-- BLOG-POST-LIST:START -->\\n' + open('../articles_list.md').read() + '\\n<!-- BLOG-POST-LIST:END -->',
    content,
    flags=re.DOTALL
)
with open('README.md', 'w') as file:
    file.write(new_content)
"
          cat README.md

      # 4. Êèê‰∫§Êõ¥Êîπ
      - name: Commit and push changes
        run: |
          cd profile_repo
          git config --local user.name "GitHub Actions"
          git config --local user.email "actions@github.com"
          git add README.md
          git commit -m "Update articles list in README" || echo "No changes to commit"
          git push origin main || echo "No changes to push"
